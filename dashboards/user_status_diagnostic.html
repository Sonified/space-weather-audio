<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Status Diagnostic</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #2196F3;
            margin-top: 30px;
            border-left: 4px solid #2196F3;
            padding-left: 10px;
        }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .key {
            color: #FFC107;
            font-weight: bold;
        }
        .value {
            color: #4CAF50;
        }
        .null {
            color: #f44336;
        }
        .success {
            color: #4CAF50;
        }
        .warning {
            color: #FF9800;
        }
        .error {
            color: #f44336;
        }
        pre {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #444;
        }
        .button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #1976D2;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #d32f2f;
        }
        .timestamp {
            color: #888;
            font-size: 12px;
        }
        .info-card {
            background: #1e1e1e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #2196F3;
        }
        .info-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #FFC107;
            font-weight: bold;
            min-width: 180px;
            flex-shrink: 0;
        }
        .info-value {
            color: #e0e0e0;
            flex-grow: 1;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-badge.in-progress {
            background: #FF9800;
            color: #1a1a1a;
        }
        .status-badge.submitted {
            background: #4CAF50;
            color: #1a1a1a;
        }
        .status-badge.none {
            background: #666;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç User Status Diagnostic Report</h1>
        <p class="timestamp">Generated: 2025-11-18 21:30:06</p>
        
        <div class="section">
            <button class="button" onclick="refreshReport()">üîÑ Refresh Report</button>
            <button class="button" onclick="copyToClipboard()">üìã Copy Report to Clipboard</button>
            <button class="button danger" onclick="clearAllData()">üóëÔ∏è Clear All Study Data (Danger!)</button>
        </div>

        <h2>üìã Participant ID</h2>
        <div class="section" id="participantId"></div>

        <h2>üìä Session State</h2>
        <div class="section" id="sessionState"></div>

        <h2>üìù Session Responses</h2>
        <div class="section" id="sessionResponses"></div>

        <h2>üèÅ Workflow Flags</h2>
        <div class="section">
            <p style="color: #888; font-size: 13px; margin-bottom: 15px;">
                üí° Change flags below and click "Save All Changes" to update your localStorage state
            </p>
            <div id="workflowFlags"></div>
            <button class="button" onclick="saveAllFlags()" style="margin-top: 15px; background: #4CAF50;">üíæ Save All Changes</button>
        </div>

        <h2>üåã Volcano Selection</h2>
        <div class="section" id="volcanoSelection"></div>

        <h2>üéØ Mode</h2>
        <div class="section" id="mode"></div>

        <h2>üì¶ All localStorage Keys</h2>
        <div class="section" id="allKeys"></div>

        <h2>üîß Diagnostic Actions</h2>
        <div class="section">
            <h3>Quick Presets</h3>
            <button class="button" onclick="setPreset('first_time')">üÜï First Time User</button>
            <button class="button" onclick="setPreset('mid_tutorial')">üìö Mid-Tutorial</button>
            <button class="button" onclick="setPreset('returning_user')">üîÑ Returning User (W2S1)</button>
            <button class="button" onclick="setPreset('mid_session')">‚ö° Mid-Session</button>
            <p style="margin-top: 10px;">Quick presets to test different user states</p>
            
            <h3 style="margin-top: 20px;">Manual Actions</h3>
            <button class="button" onclick="resetStudyFlags()">üßπ Reset All Study Flags</button>
            <button class="button danger" onclick="clearSession()">üóëÔ∏è Clear Current Session</button>
            <button class="button danger" onclick="clearAllData()">üí£ Clear Everything</button>
        </div>
    </div>

    <script>
        function getParticipantId() {
            return localStorage.getItem('participantId') || null;
        }

        function getSessionState() {
            try {
                const stateJson = localStorage.getItem('participant_session_state');
                if (!stateJson) return null;
                return JSON.parse(stateJson);
            } catch (e) {
                return { error: 'Failed to parse: ' + e.message };
            }
        }

        function getSessionResponses(participantId) {
            if (!participantId) return null;
            try {
                const key = `participant_response_${participantId}`;
                const responsesJson = localStorage.getItem(key);
                if (!responsesJson) return null;
                return JSON.parse(responsesJson);
            } catch (e) {
                return { error: 'Failed to parse: ' + e.message };
            }
        }

        function getWorkflowFlags() {
            const flags = {
                'study_has_seen_participant_setup': localStorage.getItem('study_has_seen_participant_setup'),
                'study_has_seen_welcome': localStorage.getItem('study_has_seen_welcome'),
                'study_has_seen_tutorial': localStorage.getItem('study_has_seen_tutorial'),
                'study_tutorial_completed': localStorage.getItem('study_tutorial_completed'),
                'study_weekly_session_count': localStorage.getItem('study_weekly_session_count'),
                'study_week_start_date': localStorage.getItem('study_week_start_date'),
                'study_pre_survey_completion_date': localStorage.getItem('study_pre_survey_completion_date'),
                'study_total_sessions_started': localStorage.getItem('study_total_sessions_started'),
                'study_total_sessions_completed': localStorage.getItem('study_total_sessions_completed'),
                'study_total_session_time': localStorage.getItem('study_total_session_time'),
                'study_total_regions_identified': localStorage.getItem('study_total_regions_identified'),
                'study_total_features_identified': localStorage.getItem('study_total_features_identified'),
                'study_session_completion_tracker': localStorage.getItem('study_session_completion_tracker'),
                'study_session_history': localStorage.getItem('study_session_history'),
                'study_current_session_start': localStorage.getItem('study_current_session_start')
            };
            return flags;
        }

        function getAllKeys() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                keys.push(key);
            }
            return keys.sort();
        }

        function formatValue(value) {
            if (value === null || value === undefined) {
                return '<span class="null">‚ùå NOT SET</span>';
            }
            if (typeof value === 'object') {
                return '<pre>' + JSON.stringify(value, null, 2) + '</pre>';
            }
            return '<span class="value">' + String(value) + '</span>';
        }

        function generateReport() {
            const participantId = getParticipantId();
            const sessionState = getSessionState();
            const sessionResponses = getSessionResponses(participantId);
            const workflowFlags = getWorkflowFlags();
            const selectedVolcano = localStorage.getItem('selectedVolcano');
            const selectedMode = localStorage.getItem('selectedMode');
            const allKeys = getAllKeys();

            // Participant ID
            document.getElementById('participantId').innerHTML = 
                '<span class="key">Participant ID:</span> ' + formatValue(participantId);

            // Session State
            let sessionStateHtml = '';
            if (sessionState) {
                // Format dates nicely
                const formatDate = (dateStr) => {
                    if (!dateStr || dateStr === 'Not submitted' || dateStr === 'None') return dateStr;
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: true
                        });
                    } catch (e) {
                        return dateStr;
                    }
                };
                
                const statusClass = sessionState.status === 'submitted' ? 'submitted' : 
                                   sessionState.status === 'in-progress' ? 'in-progress' : 'none';
                const statusText = sessionState.status === 'in-progress' ? 'In Progress' : 
                                  sessionState.status === 'submitted' ? 'Submitted' : sessionState.status;
                
                sessionStateHtml = `
                    <div class="info-card">
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Session ID:</span>
                            <span class="info-value">${sessionState.sessionId || '<span class="null">Not set</span>'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Participant ID:</span>
                            <span class="info-value">${sessionState.participantId || '<span class="null">Not set</span>'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Started At:</span>
                            <span class="info-value">${formatDate(sessionState.startedAt)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Submitted At:</span>
                            <span class="info-value">${formatDate(sessionState.submittedAt || 'Not submitted')}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Qualtrics Response ID:</span>
                            <span class="info-value">${sessionState.qualtricsResponseId || '<span class="null">None</span>'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Last Updated:</span>
                            <span class="info-value">${formatDate(sessionState.lastUpdated)}</span>
                        </div>
                    </div>
                `;
            } else {
                sessionStateHtml = '<span class="null">‚ùå NO SESSION STATE FOUND</span>';
            }
            document.getElementById('sessionState').innerHTML = sessionStateHtml;

            // Session Responses
            let responsesHtml = '<span class="key">Session Responses:</span><br>';
            if (sessionResponses) {
                responsesHtml += '<pre>' + JSON.stringify({
                    sessionId: sessionResponses.sessionId,
                    participantId: sessionResponses.participantId,
                    hasPre: !!sessionResponses.pre,
                    hasPost: !!sessionResponses.post,
                    hasAwesf: !!sessionResponses.awesf,
                    hasActivityLevel: !!sessionResponses.activityLevel,
                    submitted: sessionResponses.submitted || false,
                    submittedAt: sessionResponses.submittedAt || 'Not submitted',
                    qualtricsResponseId: sessionResponses.qualtricsResponseId || 'None',
                    createdAt: sessionResponses.createdAt
                }, null, 2) + '</pre>';
            } else {
                responsesHtml += '<span class="null">‚ùå NO RESPONSES FOUND</span>';
            }
            document.getElementById('sessionResponses').innerHTML = responsesHtml;

            // Workflow Flags - Interactive Controls
            let flagsHtml = '';
            Object.entries(workflowFlags).forEach(([key, value]) => {
                const isJsonField = key.includes('tracker') || key.includes('history');
                const isNumberField = key.includes('total') || key.includes('count') || key.includes('time');
                const isDateField = key.includes('date') && !isNumberField;
                const isBooleanField = (key.includes('has_seen') || key.includes('completed') || key.includes('clicked')) && !isNumberField;
                
                flagsHtml += `<div style="margin: 12px 0; padding: 12px; background: #1e1e1e; border-radius: 5px; border-left: 3px solid #2196F3;">`;
                flagsHtml += `<label style="display: block; margin-bottom: 5px;"><span class="key">${key}</span></label>`;
                
                if (isNumberField) {
                    // Number input
                    const displayValue = value || '';
                    flagsHtml += `<input type="number" id="flag_${key}" value="${displayValue}" placeholder="Number" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 14px;">`;
                    flagsHtml += `<p style="font-size: 11px; color: #888; margin: 5px 0 0 0;">Number (leave empty for null)</p>`;
                } else if (isBooleanField) {
                    // Boolean dropdown
                    const currentVal = value === 'true' ? 'true' : value === 'false' ? 'false' : 'null';
                    flagsHtml += `<select id="flag_${key}" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 14px;">`;
                    flagsHtml += `<option value="null" ${currentVal === 'null' ? 'selected' : ''}>‚ùå Not Set (null)</option>`;
                    flagsHtml += `<option value="true" ${currentVal === 'true' ? 'selected' : ''}>‚úÖ True</option>`;
                    flagsHtml += `<option value="false" ${currentVal === 'false' ? 'selected' : ''}>‚ùå False</option>`;
                    flagsHtml += `</select>`;
                } else if (isJsonField) {
                    // JSON textarea
                    const displayValue = value || '';
                    flagsHtml += `<textarea id="flag_${key}" rows="4" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-family: 'Monaco', monospace; font-size: 13px;">${displayValue}</textarea>`;
                    flagsHtml += `<p style="font-size: 11px; color: #888; margin: 5px 0 0 0;">JSON format (leave empty for null)</p>`;
                } else {
                    // Text input for dates, numbers, etc.
                    const displayValue = value || '';
                    const placeholder = isDateField ? 'YYYY-MM-DD or ISO date' : isNumberField ? 'Number' : 'Text value';
                    flagsHtml += `<input type="text" id="flag_${key}" value="${displayValue}" placeholder="${placeholder}" style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 14px;">`;
                    flagsHtml += `<p style="font-size: 11px; color: #888; margin: 5px 0 0 0;">Leave empty for null</p>`;
                }
                
                flagsHtml += `</div>`;
            });
            document.getElementById('workflowFlags').innerHTML = flagsHtml;

            // Volcano Selection
            document.getElementById('volcanoSelection').innerHTML = 
                '<span class="key">Selected Volcano:</span> ' + formatValue(selectedVolcano);

            // Mode
            document.getElementById('mode').innerHTML = 
                '<span class="key">Selected Mode:</span> ' + formatValue(selectedMode || 'Using default');

            // All Keys
            let keysHtml = '<span class="key">All localStorage Keys (${allKeys.length} total):</span><br><pre>';
            allKeys.forEach(key => {
                keysHtml += key + '\\n';
            });
            keysHtml += '</pre>';
            document.getElementById('allKeys').innerHTML = keysHtml.replace('${allKeys.length}', allKeys.length);
        }

        function refreshReport() {
            generateReport();
            alert('Report refreshed!');
        }

        function copyToClipboard() {
            const participantId = getParticipantId();
            const sessionState = getSessionState();
            const sessionResponses = getSessionResponses(participantId);
            const workflowFlags = getWorkflowFlags();
            
            // Strip out actual survey answers for privacy - only include metadata
            let responsesMetadata = null;
            if (sessionResponses) {
                responsesMetadata = {
                    sessionId: sessionResponses.sessionId,
                    participantId: sessionResponses.participantId,
                    hasPre: !!sessionResponses.pre,
                    hasPost: !!sessionResponses.post,
                    hasAwesf: !!sessionResponses.awesf,
                    hasActivityLevel: !!sessionResponses.activityLevel,
                    submitted: sessionResponses.submitted || false,
                    submittedAt: sessionResponses.submittedAt || 'Not submitted',
                    qualtricsResponseId: sessionResponses.qualtricsResponseId || 'None',
                    createdAt: sessionResponses.createdAt,
                    note: '(Survey answers excluded for privacy)'
                };
            }
            
            const report = `USER STATUS DIAGNOSTIC REPORT
Generated: ${new Date().toISOString()}

PARTICIPANT ID: ${participantId || 'NOT FOUND'}

SESSION STATE:
${JSON.stringify(sessionState, null, 2)}

SESSION RESPONSES (metadata only):
${JSON.stringify(responsesMetadata, null, 2)}

WORKFLOW FLAGS & TRACKING:
${JSON.stringify(workflowFlags, null, 2)}

VOLCANO SELECTION: ${localStorage.getItem('selectedVolcano') || 'NOT SET'}
MODE: ${localStorage.getItem('selectedMode') || 'Using default'}
`;

            navigator.clipboard.writeText(report).then(() => {
                alert('Report copied to clipboard! (Survey answers excluded for privacy)');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }

        function resetStudyFlags() {
            if (confirm('Are you sure you want to reset all study flags? This will make the system act like a first-time visit.')) {
                const flags = [
                    'study_has_seen_participant_setup',
                    'study_has_seen_welcome',
                    'study_has_seen_tutorial',
                    'study_tutorial_completed',
                    'study_weekly_session_count',
                    'study_week_start_date',
                    'study_pre_survey_completion_date',
                    'study_total_sessions_started',
                    'study_total_sessions_completed',
                    'study_total_session_time',
                    'study_total_regions_identified',
                    'study_total_features_identified',
                    'study_session_completion_tracker',
                    'study_session_history',
                    'study_current_session_start'
                ];
                flags.forEach(flag => localStorage.removeItem(flag));
                alert('All study flags and tracking data reset! Refresh the page to see changes.');
                generateReport();
            }
        }

        function clearSession() {
            const participantId = getParticipantId();
            if (!participantId) {
                alert('No participant ID found.');
                return;
            }
            if (confirm('Are you sure you want to clear the current session? This will delete all session data and responses.')) {
                localStorage.removeItem('participant_session_state');
                localStorage.removeItem(`participant_response_${participantId}`);
                alert('Session cleared!');
                generateReport();
            }
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è DANGER: Are you absolutely sure you want to clear ALL localStorage data? This cannot be undone!')) {
                if (confirm('This will delete EVERYTHING including participant ID, session data, workflow flags, and all other stored data. Continue?')) {
                    localStorage.clear();
                    alert('All data cleared! Page will reload.');
                    location.reload();
                }
            }
        }

        function saveAllFlags() {
            const workflowFlags = getWorkflowFlags();
            let changedCount = 0;
            
            Object.keys(workflowFlags).forEach(key => {
                const element = document.getElementById(`flag_${key}`);
                if (!element) return;
                
                let newValue = element.value;
                
                // Handle different input types
                if (element.tagName === 'SELECT') {
                    // Boolean dropdown
                    if (newValue === 'null') {
                        localStorage.removeItem(key);
                    } else {
                        localStorage.setItem(key, newValue);
                    }
                    changedCount++;
                } else if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                    // Text input or textarea
                    if (newValue.trim() === '') {
                        localStorage.removeItem(key);
                    } else {
                        localStorage.setItem(key, newValue);
                    }
                    changedCount++;
                }
            });
            
            alert(`‚úÖ Saved ${changedCount} flags! Refresh the report to see changes.`);
            generateReport();
        }
        
        function setPreset(presetName) {
            switch (presetName) {
                case 'first_time':
                    // Clear everything - brand new user
                    localStorage.clear();
                    alert('‚úÖ Set to: First Time User\nAll flags cleared. The app will show full onboarding.');
                    break;
                    
                case 'mid_tutorial':
                    // User has done participant setup and pre-survey, but not finished tutorial
                    localStorage.setItem('study_has_seen_participant_setup', 'true');
                    localStorage.setItem('study_has_seen_welcome', 'true');
                    localStorage.setItem('study_pre_survey_completion_date', getTodayDateString());
                    localStorage.removeItem('study_tutorial_completed');
                    localStorage.removeItem('study_begin_analysis_clicked_this_session');
                    alert('‚úÖ Set to: Mid-Tutorial\nUser has completed setup and pre-survey, currently in tutorial.');
                    break;
                    
                case 'returning_user':
                    // Returning user starting Week 2 Session 1
                    localStorage.setItem('study_has_seen_participant_setup', 'true');
                    localStorage.setItem('study_has_seen_welcome', 'true');
                    localStorage.setItem('study_tutorial_completed', 'true');
                    const tracker = {
                        week1: [true, true],
                        week2: [false, false],
                        week3: [false, false]
                    };
                    localStorage.setItem('study_session_completion_tracker', JSON.stringify(tracker));
                    localStorage.removeItem('study_pre_survey_completion_date');
                    localStorage.removeItem('study_begin_analysis_clicked_this_session');
                    alert('‚úÖ Set to: Returning User (W2S1)\nCompleted Week 1, starting Week 2 Session 1. Will show Welcome Back ‚Üí Pre-Survey.');
                    break;
                    
                case 'mid_session':
                    // Mid-session, can analyze immediately
                    localStorage.setItem('study_has_seen_participant_setup', 'true');
                    localStorage.setItem('study_has_seen_welcome', 'true');
                    localStorage.setItem('study_tutorial_completed', 'true');
                    localStorage.setItem('study_begin_analysis_clicked_this_session', 'true');
                    localStorage.setItem('study_pre_survey_completion_date', getTodayDateString());
                    alert('‚úÖ Set to: Mid-Session\nUser has completed everything and clicked Begin Analysis. Can analyze immediately.');
                    break;
            }
            
            generateReport();
        }
        
        function getTodayDateString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Generate report on page load
        generateReport();
    </script>
</body>
</html>
