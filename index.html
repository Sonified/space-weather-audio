<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volcano Audification Study</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåã</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/fzstd@0.1.1/umd/index.min.js"></script>
    <style>
        /* Meta-variables for axis tick label styling */
        :root {
            --axis-label-font-size: 14px;      /* Size of tick labels */
            --axis-label-color: #bbb;          /* Brightness/color of tick label text */
            --axis-tick-color: #666;           /* Color of tick marks (lines) */
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; align-items: flex-end; margin-bottom: 6px; margin-top: 0px; position: relative; z-index: 1001;">
            <div id="modeSelectorContainer" style="flex: 1; display: flex; align-items: center; gap: 8px; visibility: hidden; opacity: 0; transition: opacity 0.3s;">
                <label for="modeSelector" style="font-size: 13px; font-weight: 600; color: #aaa; white-space: nowrap; user-select: none;">Mode:</label>
                <select id="modeSelector" style="padding: 4px 8px; font-size: 13px; font-weight: 600; border-radius: 4px; border: 1px solid #555; background: rgba(60, 60, 60, 0.9); color: #ddd; cursor: pointer; min-width: 120px;">
                    <option value="personal">üë§ Personal</option>
                    <option value="dev" selected>üîß Dev</option>
                    <option value="study">üéì Study</option>
                    <option value="study_clean">üßπ Study Clean</option>
                    <option value="study_w2_s1">üîÑ Study W2 S1</option>
                    <option value="study_w2_s1_returning">üîÅ Study W2 S1 Returning</option>
                    <option value="study_w2_s2">üîÑ Study W2 S2</option>
                    <option value="tutorial_end">üé¨ Tutorial End</option>
                </select>
            </div>
            <h1 style="margin: 0 0 0 0; flex: 0 0 auto; font-size: 1.5em; opacity: 0.88; color: #fff;">Volcano Audification Study</h1>
            <div style="flex: 1; display: flex; justify-content: flex-end; align-items: flex-end; gap: 8px;">
                <div id="participantIdDisplay" style="display: none; margin-bottom: 0;">
                    <span id="participantIdText" style="font-size: 13px; color: #aaa; cursor: pointer; user-select: none; white-space: nowrap; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(100, 100, 100, 0.6); background: rgba(40, 40, 40, 0.4); transition: background-color 0.2s; display: inline-block;" title="Click to open Participant Setup">
                        Participant ID: <span id="participantIdValue" style="font-weight: 600; color: #bbb;">--</span>
                    </span>
                </div>
                <button id="tutorialHelpBtn" type="button" style="margin-bottom: 0; width: 24px; height: 24px; border-radius: 50%; border: 1px solid #aaa; background: transparent; color: #aaa; cursor: pointer; font-size: 14px; font-weight: 600; padding: 0; display: none; align-items: center; justify-content: center; transition: all 0.2s;" title="Help - Revisit Tutorial">?</button>
            </div>
        </div>
        
        <!-- Cache Row -->
        <div class="panel panel-cache" id="cachePanel" style="padding: 15px 20px; display: none;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 700; font-size: 16px; color: #333; margin: 0;">Cache:</label>
                <button type="button" id="purgeCacheBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üóëÔ∏è Purge CDN Cache</button>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="bypassCache" style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="bypassCache" style="margin-bottom: 0; cursor: pointer; font-weight: 700; font-size: 14px; color: #333;">Bypass CDN Cache</label>
                </div>
                <button type="button" id="downloadBtn" disabled style="padding: 10px 20px; font-size: 14px; min-width: auto;">üíæ Download Audio File</button>
            </div>
        </div>
        
        <div class="panel panel-selection">
            <div class="controls">
                <div class="control-group" style="flex-direction: row; align-items: center; gap: 8px;">
                    <label for="volcano" style="margin-bottom: 0;">Volcano:</label>
                    <select id="volcano" style="background: rgba(255, 255, 255, 0.85);">
                        <option value="kilauea">Kƒ´lauea (HI)</option>
                        <option value="maunaloa">Mauna Loa (HI)</option>
                        <option value="greatsitkin">Great Sitkin (AK)</option>
                        <option value="shishaldin">Shishaldin (AK)</option>
                        <option value="spurr">Mount Spurr (AK)</option>
                    </select>
                </div>
                
                <div class="control-group" style="display: none;">
                    <label for="dataType">Data Type:</label>
                    <select id="dataType">
                        <option value="seismic">Seismic (Z-component)</option>
                        <option value="infrasound">Infrasound</option>
                    </select>
                </div>
                
                <div class="control-group" id="stationControlGroup" style="display: none;">
                    <label for="station">Station (by distance):</label>
                    <select id="station" style="min-width: 300px;">
                        <option value="">Loading stations...</option>
                    </select>
                </div>
                
                <div class="control-group" id="durationControlGroup" style="display: none;">
                    <label for="duration">Duration:</label>
                    <select id="duration">
                        <option value="0.5">30 minutes</option>
                        <option value="1">1 hour</option>
                        <option value="2">2 hours</option>
                        <option value="4">4 hours</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <button type="button" id="startBtn" style="min-width: 150px; padding: 10px 20px; font-size: 16px;">üì° Fetch Data</button>
                </div>
                
                <div class="control-group" style="display: flex; flex-direction: row; align-items: center; gap: 8px;">
                    <input type="checkbox" id="autoPlay" checked style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="autoPlay" style="margin-bottom: 0; cursor: pointer; font-weight: 600; font-size: 18px; color: #333;">Auto Play</label>
                </div>
                
                <div class="control-group" style="margin-left: 15px; flex: 1; min-width: 200px;">
                    <div class="status info" id="status" style="margin-top: 0; padding: 10px 15px; width: 100%;">
                    </div>
                </div>
                
                <div class="control-group" id="forceIrisControlGroup" style="margin-left: auto; display: none;">
                    <button type="button" id="forceIrisBtn" style="padding: 8px 16px; font-size: 14px; min-width: auto; background: #6c757d; border-color: #6c757d;">üåê Force IRIS Fetch: OFF</button>
                </div>
                
                <div class="control-group" style="display: none;">
                    <label for="baseSampleRate">Base Sampling Rate:</label>
                    <select id="baseSampleRate">
                        <option value="44100" selected>44.1 kHz (441x)</option>
                        <option value="48000">48 kHz (480x)</option>
                        <option value="50000">50 kHz (500x)</option>
                        <option value="96000">96 kHz (960x)</option>
                        <option value="192000">192 kHz (1920x)</option>
                        <option value="200000">200 kHz (2000x)</option>
                        <option value="441000">441 kHz (4410x)</option>
                        <option value="1000000">1 MHz (10000x)</option>
                    </select>
                </div>
                
                <div class="control-group" style="display: none;">
                    <button type="button" id="antiAliasingBtn" class="loop-active" style="padding: 8px 16px; font-size: 14px; min-width: auto;">üéõÔ∏è Anti-Alias: ON</button>
                </div>
                
                <div class="control-group" style="display: none;">
                    <label for="highpassFreq" id="highpassLabel">High Pass (@ 44.1k):</label>
                    <select id="highpassFreq">
                        <option value="none">None</option>
                        <option value="0.01">0.01 Hz</option>
                        <option value="0.02" selected>0.02 Hz</option>
                        <option value="0.045">0.045 Hz</option>
                    </select>
                </div>
                
                <div style="display: none;">
                    <input type="checkbox" id="enableNormalize" checked style="width: 24px; height: 24px; cursor: pointer;">
                    <label for="enableNormalize" style="margin-bottom: 0; cursor: pointer; font-weight: 700; font-size: 18px; color: #333;">Normalization</label>
                </div>
            </div>
        </div>
        
        <div class="panel panel-playback">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; width: 100%; box-sizing: border-box;">
                <button type="button" id="playPauseBtn" disabled style="width: 135px; min-width: 135px;">‚è∏Ô∏è Pause</button>
                <button type="button" id="loopBtn" disabled style="width: 135px; min-width: 135px;">üîÅ Loop</button>
                <div style="display: flex; align-items: center; flex: 1 1 auto; min-width: 180px; max-width: min(450px, 100%); gap: 10px; padding: 0 15px 0 15px; box-sizing: border-box;">
                    <label for="playbackSpeed" id="speedLabel" style="font-weight: 600; white-space: nowrap; font-size: 18px; flex-shrink: 0; cursor: pointer; user-select: none; opacity: 0.5;" title="Click to reset to 1.0x">Speed: <span id="speedValue">1.0x</span></label>
                    <input type="range" id="playbackSpeed" min="0" max="1000" step="1" value="667" disabled style="flex: 1; min-width: 0;">
                </div>
                <div style="display: flex; align-items: center; flex: 1 1 auto; min-width: 180px; max-width: min(350px, 100%); gap: 10px; padding: 0 15px 0 5px; box-sizing: border-box;">
                    <label for="volumeSlider" id="volumeLabel" style="font-weight: 600; white-space: nowrap; font-size: 18px; flex-shrink: 0; cursor: pointer; user-select: none; opacity: 0.5;" title="Click to reset to 1.0">Volume: <span id="volumeValue">1.0</span></label>
                    <input type="range" id="volumeSlider" min="0" max="200" step="1" value="100" disabled style="flex: 1; min-width: 0;">
                </div>
                <button type="button" id="completeBtn" disabled class="begin-analysis-btn" style="margin-left: auto; padding: 10px 16px; font-size: 16px; font-weight: 700; background: #007bff; border: 2px solid #007bff; color: white; border-radius: 6px; cursor: not-allowed; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); opacity: 0.5; display: flex; align-items: center; justify-content: center; vertical-align: middle;" onmouseover="if(!this.disabled) { this.style.background='#0056b3'; this.style.boxShadow='0 3px 6px rgba(0,0,0,0.3)'; }" onmouseout="if(!this.disabled) { this.style.background='#007bff'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)'; }">Begin Analysis</button>
                <div style="display: none; align-items: center; flex: 1 1 auto; min-width: 200px; max-width: min(500px, 100%); gap: 10px; padding: 0 20px; box-sizing: border-box;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="removeDCOffset" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-weight: 600; white-space: nowrap; font-size: 18px;">Drift Removal:</span>
                    </label>
                    <label for="waveformFilterSlider" id="waveformFilterLabel" style="font-weight: 600; white-space: nowrap; font-size: 18px; flex-shrink: 0; cursor: pointer; user-select: none;" title="Adjust drift removal aggressiveness"><span id="waveformFilterValue">0.9974</span></label>
                    <input type="range" id="waveformFilterSlider" min="0" max="100" step="1" value="95" style="flex: 1; min-width: 0;">
                </div>
            </div>
        </div>
        
        <div class="panel panel-visualization" style="position: relative;">
            <canvas id="waveform" width="1200" height="135"></canvas>
            <canvas id="waveform-axis" width="60" height="135"></canvas>
            <canvas id="waveform-x-axis" width="1200" height="40"></canvas>
            <canvas id="waveform-buttons" width="1200" height="135"></canvas>
            <canvas id="spectrogram" width="1200" height="450"></canvas>
            <canvas id="spectrogram-axis" width="60" height="450"></canvas>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 30px; margin-top: 8px; padding-top: 4px; padding-bottom: 0; padding-left: 8px; padding-right: 40px;">
                <!-- Realtime Oscilloscope - Small glass enclosure on the left -->
                <div id="oscilloscope-panel" style="display: none; pointer-events: none;">
                    <div style="position: relative; border-radius: 5px; padding: 4px; background: linear-gradient(135deg, rgba(60, 60, 80, 0.5) 0%, rgba(40, 40, 60, 0.4) 100%); box-shadow: 0 0 5px rgba(255, 150, 120, 0.2), inset 0 0 20px rgba(100, 100, 120, 0.5), inset 0 1px 2px rgba(255, 255, 255, 0.15), 0 1px 4px rgba(0, 0, 0, 0.5); backdrop-filter: blur(6px); border: 0.2px solid rgba(30, 30, 40, 0.6);">
                        <!-- Glass frame effect -->
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 4px; border: 0.1px solid rgba(10, 10, 15, 0.8); pointer-events: none; box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.2), inset 0 -1px 1px rgba(0, 0, 0, 0.3);"></div>
                        <div style="position: relative;">
                            <canvas id="oscilloscope" width="80" height="28" style="display: block; width: 80px; height: 28px; border-radius: 2px; background: rgba(5, 3, 3, 0.98); border: 0.15px solid rgba(30, 30, 40, 0.7); box-shadow: inset 0 0 25px rgba(255, 100, 80, 0.6), inset 0 0 15px rgba(255, 150, 120, 0.4), inset 0 1px 2px rgba(0, 0, 0, 0.6);"></canvas>
                            <!-- Frosted glass texture overlay -->
                            <div id="oscilloscope-frost" style="position: absolute; top: 0; left: 0; width: 80px; height: 28px; border-radius: 2px; pointer-events: none; opacity: 0.5; background-image: 
                                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 255, 255, 0.03) 2px, rgba(255, 255, 255, 0.03) 4px),
                                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255, 255, 255, 0.03) 2px, rgba(255, 255, 255, 0.03) 4px),
                                repeating-linear-gradient(45deg, transparent, transparent 1px, rgba(255, 255, 255, 0.02) 1px, rgba(255, 255, 255, 0.02) 2px),
                                repeating-linear-gradient(-45deg, transparent, transparent 1px, rgba(0, 0, 0, 0.05) 1px, rgba(0, 0, 0, 0.05) 2px);
                                backdrop-filter: blur(0.5px);
                                mix-blend-mode: overlay;"></div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 30px; margin-left: auto;">
                    <div style="display: none;">
                        <input type="checkbox" id="playOnClick" checked style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="playOnClick" style="margin-bottom: 0; cursor: pointer; font-weight: 700; font-size: 14px; color: #ffe8e8; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); white-space: nowrap;">Play on Click</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="frequencyScale" style="font-size: 14px; font-weight: 700; white-space: nowrap; user-select: none; color: #ffe8e8; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Frequency Scale:</label>
                    <select id="frequencyScale" style="padding: 4px 8px; font-size: 14px; font-weight: 600; border-radius: 4px; border: 1px solid #ccc; background: rgba(255, 255, 255, 0.95); cursor: pointer;">
                        <option value="linear">Linear (C)</option>
                        <option value="sqrt" selected>Square Root (V)</option>
                        <option value="logarithmic">Logarithmic (B)</option>
                    </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tracked Regions Panel -->
        <div class="panel panel-regions" id="trackedRegionsPanel">
            <h2 style="margin-bottom: 12px; font-size: 1.3em;">Selected Regions</h2>
            <div id="regionsListContainer">
                <div id="regionsList"></div>
            </div>
        </div>
        
        <!-- Metrics Panel -->
        <div class="panel panel-metrics" id="metricsPanel" style="display: none;">
            <div class="metrics">
                <div class="metric">
                    <div class="metric-label">Time to First Audio</div>
                    <div class="metric-value" id="ttfa">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Download Size</div>
                    <div class="metric-value" id="downloadSize">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Sample Count</div>
                    <div class="metric-value" id="sampleCount">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Current Position</div>
                    <div class="metric-value" id="currentPosition">0m 0s</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Playback Duration</div>
                    <div class="metric-value" id="playbackDuration">--</div>
                </div>
            </div>
        </div>
        
        <!-- Simulate Row -->
        <div class="panel panel-simulate" style="padding: 15px 20px;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 700; font-size: 16px; color: #333; margin: 0;">Simulate:</label>
                <button type="button" id="participantModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üë§ Participant Setup</button>
                <button type="button" id="welcomeModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üëã Welcome</button>
                <button type="button" id="preSurveyModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üìä Pre-Survey</button>
                <button type="button" id="activityLevelModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üåã Activity Level</button>
                <button type="button" id="awesfModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">‚ú® AWE-SF</button>
                <button type="button" id="postSurveyModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üìä Post-Survey</button>
                <button type="button" id="endModalBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üéâ End</button>
                <button type="button" id="submitBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto; background: #28a745; border-color: #28a745; color: white; font-weight: 600;">üì§ Submit to Qualtrics</button>
                <button type="button" id="adminModeBtn" style="margin-left: auto; padding: 10px 20px; font-size: 14px; min-width: auto; background: #6c757d; border-color: #6c757d; color: white;">üëë Admin Mode: OFF</button>
            </div>
        </div>
    </div>
    
    <!-- Permanent Modal Overlay Background -->
    <!-- Hidden by default, shown only in Study Mode when modals are active -->
    <!-- Inline script to show overlay immediately in study modes (prevents UI flash) -->
    <script>
        (function() {
            const storedMode = localStorage.getItem('selectedMode');
            const isStudyMode = storedMode === 'study' || 
                               storedMode === 'study_clean' || 
                               storedMode === 'study_w2_s1' || 
                               storedMode === 'study_w2_s1_returning' || 
                               storedMode === 'study_w2_s2' || 
                               storedMode === 'tutorial_end';
            
            // Show overlay immediately if in study mode
            if (isStudyMode) {
                document.write('<div id="permanentOverlay" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 1000; align-items: center; justify-content: center; opacity: 1;">');
            } else {
                document.write('<div id="permanentOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 1000; align-items: center; justify-content: center;">');
            }
        })();
    </script>
        <!-- Modals injected dynamically by js/modal-templates.js will appear here -->
    </div>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CORE SYSTEM: Loads first, always works, never breaks -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script type="module">
        import { initFlameEngine } from './js/core/flame-engine.js';
        import { initErrorSystem } from './js/core/error-system.js';
        
        // Initialize core systems early
        const flame = initFlameEngine();
        const errorSystem = initErrorSystem(flame);
        
        // Expose overheat mode globally for debugging/testing
        window.enterOverheatMode = () => {
            flame.enterOverheatMode();
        };
        
        window.exitOverheatMode = () => {
            flame.exitOverheatMode();
        };
        
        console.log('üî• Core systems initialized (flame engine + error system)');
    </script>
    
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- APPLICATION LAYER: Main app code (might break during beta) -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
