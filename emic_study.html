<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>EMIC Wave Analysis Study</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî¨</text></svg>">
    <script>
        // Force EMIC_STUDY mode before any modules load
        window.__EMIC_STUDY_MODE = true;

        // Single source of truth for EMIC study time range
        window.__EMIC_CONFIG = {
            spacecraft: 'GOES',
            dataset: 'DN_MAGN-L2-HIRES_G16',
            startTime: '2022-08-17T00:00:00.000Z',
            endTime: '2022-08-24T00:00:00.000Z'
        };

        // Apply saved colormap accent colors BEFORE stylesheet loads to prevent flash
        (function() {
            var accents = {
                solar:   { color: '#ff6b35', rgb: '255, 107, 53', bg: 'linear-gradient(135deg, #1a0f0a, #100805)', pageBg: '#3a2b2b' },
                turbo:   { color: '#23a6d5', rgb: '35, 166, 213', bg: 'linear-gradient(135deg, #1a2830, #0f1a20)', pageBg: '#2b303a' },
                viridis: { color: '#21918c', rgb: '33, 145, 140', bg: 'linear-gradient(135deg, #1e2830, #121c22)', pageBg: '#2b3535' },
                jet:     { color: '#5dadec', rgb: '93, 173, 236', bg: 'linear-gradient(135deg, #1e2438, #121820)', pageBg: '#2b2b3a' },
                aurora:  { color: '#9b4dca', rgb: '155, 77, 202', bg: 'linear-gradient(135deg, #2a2540, #1a1428)', pageBg: '#332b3a' },
                plasma:  { color: '#22d3ee', rgb: '34, 211, 238', bg: 'linear-gradient(135deg, #1c2530, #101820)', pageBg: '#2b333a' },
                inferno: { color: '#808080', rgb: '128, 128, 128', bg: 'linear-gradient(135deg, #252a40, #161a28)', pageBg: '#2b2b3a' }
            };
            var saved = localStorage.getItem('colormap');
            var a = accents[saved] || accents.inferno;
            var r = document.documentElement;
            r.style.setProperty('--accent-color', a.color);
            r.style.setProperty('--accent-rgb', a.rgb);
            r.style.setProperty('--accent-glow', 'rgba(' + a.rgb + ', 0.25)');
            r.style.setProperty('--accent-border', 'rgba(' + a.rgb + ', 0.2)');
            r.style.setProperty('--accent-soft', 'rgba(' + a.rgb + ', 0.12)');
            r.style.setProperty('--accent-bg', a.bg);
            r.style.setProperty('--page-bg', a.pageBg);
            r.style.background = a.pageBg;
        })();
    </script>
    <link rel="stylesheet" href="styles.css?v=20260212g">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --axis-label-font-size: 14px;
            --axis-label-color: #bbb;
            --axis-tick-color: #666;
            --panel-label-size: 15px;
        }
        
        /* EMIC: taller spectrogram, shorter minimap (14px transferred) */
        #spectrogram { height: 554px; }
        #waveform { height: 121px; }

        /* EMIC Study specific styles */
        .emic-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 6px;
            margin-top: 0px;
            position: relative;
            z-index: 1001;
        }
        
        .emic-header h1 {
            margin: 0;
            font-size: 1.5em;
            opacity: 0.88;
            color: #fff;
        }
        
        .emic-header .subtitle {
            font-size: 0.55em;
            opacity: 0.6;
            font-weight: 400;
            display: block;
            margin-top: 2px;
        }
        
        .emic-participant-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .emic-participant-bar label {
            font-size: 13px;
            font-weight: 600;
            color: #aaa;
            white-space: nowrap;
        }
        
        .emic-participant-bar input {
            padding: 4px 10px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 4px;
            border: 1px solid #555;
            background: rgba(60, 60, 60, 0.9);
            color: #ddd;
            width: 120px;
        }
        
        .emic-controls-bar {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 8px 12px;
            flex-wrap: wrap;
        }
        
        .emic-btn-group {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .emic-btn-group label {
            font-size: var(--panel-label-size);
            font-weight: 600;
            color: #444;
            margin-right: 4px;
            white-space: nowrap;
        }
        
        .emic-btn {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 4px;
            border: 1px solid #555;
            background: rgba(60, 60, 60, 0.9);
            color: #ccc;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        
        .emic-btn:hover {
            background: rgba(80, 80, 80, 0.9);
            color: #fff;
        }
        
        .emic-btn.active {
            background: rgba(102, 126, 234, 0.8);
            border-color: rgba(102, 126, 234, 0.9);
            color: #fff;
        }
        
        .emic-placeholder-note {
            font-size: 11px;
            color: #666;
            font-style: italic;
            padding: 0 8px;
        }
        .modal-content,
        #participantModal .modal-content {
            max-width: 440px !important;
            min-width: 280px !important;
            width: 80% !important;
        }
        
        #backgroundQuestionModal .modal-content,
        #dataAnalysisQuestionModal .modal-content {
            max-width: 612px !important;
            min-width: 320px !important;
            width: 85% !important;
            padding: 24px 28px !important;
        }

        #feedbackQuestionModal .modal-content,
        #referralQuestionModal .modal-content {
            max-width: 680px !important;
            min-width: 320px !important;
            width: 88% !important;
            padding: 24px 28px !important;
        }

        #welcomeModal .modal-content,
        #emicAboutModal .modal-content {
            max-width: 720px !important;
            min-width: 320px !important;
            width: 90% !important;
            padding: 24px 28px !important;
        }
        
        #participantModal .modal-body p:first-child {
            font-size: 20px !important;
        }
        
        #participantModal .modal-body p:nth-child(2) {
            font-size: 16px !important;
        }
        
        .begin-analysis-btn {
            display: none !important;
        }
        
        .modal-submit {
            width: auto;
            min-width: 200px;
            display: block;
            margin: 16px auto 0 auto;
        }

        /* Hamburger button */
        .hamburger-btn {
            display: none; /* shown by Advanced mode */
            position: fixed;
            top: 10px;
            left: 12px;
            z-index: 1100;
            font-size: 22px;
            color: #999;
            cursor: pointer;
            user-select: none;
            line-height: 1;
            padding: 4px 6px;
            border-radius: 4px;
            transition: color 0.15s, background-color 0.15s, left 0.25s ease;
        }
        .hamburger-btn:hover {
            color: #ddd;
            background: rgba(255, 255, 255, 0.08);
        }

        /* Settings drawer ‚Äî push layout */
        .settings-drawer {
            position: fixed;
            top: 0;
            left: 0;
            width: 290px;
            height: 100%;
            background: #1e1e1e;
            border-right: 1px solid #444;
            z-index: 1100;
            transform: translateX(-100%);
            transition: transform 0.25s ease;
            overflow-y: auto;
            font-size: 13px;
            color: #ddd;
        }
        .settings-drawer.open { transform: translateX(0); }

        /* Push main content when drawer is open */
        .container {
            transition: margin-left 0.25s ease;
        }
        body.drawer-open .container {
            margin-left: 290px;
        }
        body.drawer-open .hamburger-btn {
            left: 302px;
        }

        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px 10px;
            border-bottom: 1px solid #333;
        }
        .drawer-title {
            font-size: 16px;
            font-weight: 600;
            color: #eee;
        }
        .drawer-close {
            font-size: 22px;
            color: #888;
            cursor: pointer;
            line-height: 1;
            padding: 2px 6px;
            border-radius: 4px;
            transition: color 0.15s, background-color 0.15s;
            user-select: none;
        }
        .drawer-close:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .drawer-section {
            padding: 14px 16px;
            border-bottom: 1px solid #2a2a2a;
        }
        .drawer-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #777;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 10px;
        }
        .drawer-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 4px 0;
        }
        .drawer-label {
            font-size: 13px;
            font-weight: 500;
            color: #bbb;
            cursor: pointer;
            user-select: none;
        }
        .drawer-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #80d0ff;
        }
        .drawer-input {
            width: 70px;
            padding: 4px 8px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #ddd;
            font-size: 13px;
            font-family: monospace;
            text-align: right;
        }
        .drawer-input:focus {
            outline: none;
            border-color: #80d0ff;
        }

        /* Post-study questionnaire radio choices */
        .radio-choice:hover {
            background: rgba(0, 123, 255, 0.06);
            border-color: #aac8e8;
        }
        .radio-choice:has(input:checked) {
            background: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- EMIC Study Header (matches main site layout) -->
        <div class="top-header-bar" style="display: flex; align-items: flex-end; margin-bottom: 6px; margin-top: 0px; position: relative; z-index: 1001;">
            <div style="flex: 1;"></div>
            <h1 style="margin: 0 0 0 0; flex: 0 0 auto; font-size: 1.5em; opacity: 0.88; color: #fff;">EMIC Wave Analysis Study</h1>
            <div style="flex: 1; display: flex; justify-content: flex-end; align-items: flex-end; gap: 8px;">
                <button id="aboutInfoBtn" type="button" class="header-info-btn" title="About this study">i</button>
                <div id="participantIdDisplay" style="display: block; margin-bottom: 0;">
                    <span id="participantIdText" style="font-size: 13px; color: #aaa; cursor: pointer; user-select: none; white-space: nowrap; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(100, 100, 100, 0.6); background: rgba(40, 40, 40, 0.4); transition: background-color 0.2s; display: inline-block;" title="Click to open Participant Setup">
                        Participant ID: <span id="participantIdValue" style="font-weight: 600; color: #bbb;">--</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- EMIC Study Controls: Stretch Algorithm + Speed -->
        <div class="panel" style="padding: 8px 15px;">
            <div class="emic-controls-bar">
                <button type="button" id="startBtn" style="padding: 6px 14px; font-size: 14px;">üì° Fetch Data</button>
                <div style="width: 0px; height: 0px; background: transparent; margin: 0 8px;"></div>
                <div id="componentSelectorContainer" style="display: flex; align-items: center; gap: 6px; padding: 0 8px; opacity: 0.4; pointer-events: none;">
                    <label for="componentSelector" style="font-size: var(--panel-label-size); font-weight: 600; color: #666; white-space: nowrap;">Component:</label>
                    <select id="componentSelector" style="padding: 6px 10px; font-size: 14px; border-radius: 4px; border: 1px solid #555; background: white; color: #333; cursor: pointer; height: 32px;">
                        <option value="0">br (Radial)</option>
                        <option value="1">bt (Tangential)</option>
                        <option value="2">bn (Normal)</option>
                    </select>
                </div>
                <div style="width: 0px; height: 0px; background: transparent; margin: 0 4px;"></div>
                <div id="detrendContainer" style="display: flex; align-items: center; gap: 6px; padding: 0 8px;">
                    <label for="removeDCOffsetEmic" style="font-size: var(--panel-label-size); font-weight: 600; color: #666; cursor: pointer; white-space: nowrap;">De-trend:</label>
                    <input type="checkbox" id="removeDCOffsetEmic" style="width: 16px; height: 16px; cursor: pointer;" onchange="document.getElementById('removeDCOffset').checked = this.checked; document.getElementById('removeDCOffset').dispatchEvent(new Event('change'));">
                </div>
                <div style="width: 0px; height: 0px; background: transparent; margin: 0 8px;"></div>
                <div class="status info" id="status" style="margin: 0; padding: 6px 12px; flex: 1; min-width: 80px; font-size: 13px;"></div>
            </div>
        </div>

        <!-- Hidden elements that main.js expects to exist -->
        <div id="modeSelectorContainer" style="display: none;">
            <select id="modeSelector" style="display: none;">
                <option value="emic_study" selected>üî¨ EMIC Study</option>
            </select>
        </div>
        
        <!-- Cache Row (hidden by default, same as index.html) -->
        <div class="panel panel-cache" id="cachePanel" style="padding: 15px 20px; display: none;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <label style="font-weight: 700; font-size: 16px; color: #333; margin: 0;">Cache:</label>
                <button type="button" id="purgeCacheBtn" style="padding: 10px 20px; font-size: 14px; min-width: auto;">üóëÔ∏è Purge CDN Cache</button>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="bypassCache" style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="bypassCache" style="margin-bottom: 0; cursor: pointer; font-weight: 700; font-size: 14px; color: #333;">Bypass CDN Cache</label>
                </div>
                <button type="button" id="downloadBtn" disabled style="padding: 10px 20px; font-size: 14px; min-width: auto;">üíæ Download Audio File</button>
            </div>
        </div>
        
        <!-- Selection Panel ‚Äî hidden, but elements exist for startStreaming() -->
        <div class="panel panel-selection" style="display: none;">
            <div class="controls">
                <div class="controls-row-1">
                    <div class="control-group">
                        <select id="spacecraft"><option value="GOES" selected>GOES-16</option></select>
                    </div>
                    <div class="control-group">
                        <select id="dataType"><option value="DN_MAGN-L2-HIRES_G16" selected>DN_MAGN-L2-HIRES_G16</option></select>
                    </div>
                    <div class="control-group">
                        <input type="checkbox" id="removeDCOffset">
                    </div>
                    <div class="control-group">
                        <select id="recentSearches"><option value="">-- Select Recent Search --</option></select>
                        <button type="button" id="shareBtn" disabled style="display:none;">Share</button>
                    </div>
                </div>
                <div class="control-group" id="stationControlGroup" style="display: none;">
                    <select id="station"><option value="">Loading stations...</option></select>
                </div>
                <div class="control-group" id="durationControlGroup" style="display: none;">
                    <select id="duration"><option value="24" selected>24 hours</option></select>
                </div>
                <div class="control-group" style="display: none;">
                    <input type="checkbox" id="autoPlay" checked>
                </div>
                <div class="control-group" id="forceIrisControlGroup" style="display: none;">
                    <button type="button" id="forceIrisBtn">üåê Force IRIS Fetch: OFF</button>
                </div>
                <div class="control-group" style="display: none;">
                    <select id="baseSampleRate"><option value="44100" selected>44.1 kHz</option></select>
                </div>
                <div class="control-group" style="display: none;">
                    <button type="button" id="antiAliasingBtn" class="loop-active">üéõÔ∏è Anti-Alias: ON</button>
                </div>
                <div class="control-group" style="display: none;">
                    <select id="highpassFreq"><option value="0.02" selected>0.02 Hz</option></select>
                </div>
                <div style="display: none;">
                    <input type="checkbox" id="enableNormalize" checked>
                </div>
            </div>
        </div>
        
        <!-- Playback Controls -->
        <div class="panel panel-playback">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: nowrap; width: 100%; box-sizing: border-box; overflow-x: auto;">
                <button type="button" id="playPauseBtn" disabled style="width: 135px; min-width: 135px;">‚è∏Ô∏è Pause</button>
                <button type="button" id="loopBtn" disabled style="width: 135px; min-width: 135px;">üîÅ Loop</button>
                <div style="display: none; align-items: center; flex: 1 1 auto; min-width: 180px; max-width: min(450px, 100%); gap: 10px; padding: 0 15px;">
                    <label for="playbackSpeed" id="speedLabel" style="font-weight: 600; white-space: nowrap; font-size: var(--panel-label-size); flex-shrink: 0; cursor: pointer; user-select: none;" title="Click to reset to 1.0x">Speed: <span id="speedValue">1.0x</span></label>
                    <input type="range" id="playbackSpeed" min="0" max="1000" step="1" value="667" style="flex: 1; min-width: 0;">
                </div>
                <div style="display: flex; align-items: center; flex: 1 1 auto; min-width: 180px; max-width: min(350px, 100%); gap: 10px; padding: 0 15px 0 5px;">
                    <label for="volumeSlider" id="volumeLabel" style="font-weight: 600; white-space: nowrap; font-size: var(--panel-label-size); flex-shrink: 0; cursor: pointer; user-select: none;" title="Click to reset to 1.0">Volume: <span id="volumeValue">1.0</span></label>
                    <input type="range" id="volumeSlider" min="0" max="200" step="1" value="100" style="flex: 1; min-width: 0;">
                </div>
                <div style="width: 0px; height: 0px; background: transparent; margin: 0 4px;"></div>
                <div class="emic-btn-group">
                    <label>Stretch:</label>
                    <button type="button" class="emic-btn active" data-stretch="resample">Resample</button>
                    <button type="button" class="emic-btn" data-stretch="granular">Granular</button>
                    <button type="button" class="emic-btn" data-stretch="paulstretch">Paulstretch</button>
                    <button type="button" class="emic-btn" data-stretch="wavelet">Wavelet</button>
                </div>
                <div style="width: 0px; height: 0px; background: transparent; margin: 0 4px;"></div>
                <div class="emic-btn-group">
                    <label>Speed:</label>
                    <button type="button" class="emic-btn" data-speed="0.5">0.5√ó</button>
                    <button type="button" class="emic-btn" data-speed="0.75">0.75√ó</button>
                    <button type="button" class="emic-btn active" data-speed="1">1√ó</button>
                </div>
                <button type="button" id="completeBtn" disabled class="begin-analysis-btn" style="display: none;">Begin Analysis</button>
                <div style="display: none;">
                    <input type="range" id="waveformFilterSlider" min="0" max="100" step="1" value="95">
                    <label for="waveformFilterSlider" id="waveformFilterLabel"><span id="waveformFilterValue">0.9974</span></label>
                </div>
            </div>
        </div>
        
        <!-- Visualization Panel -->
        <div class="panel panel-visualization" style="position: relative;">
            <canvas id="waveform" width="1200" height="121"></canvas>
            <canvas id="waveform-axis" width="60" height="121"></canvas>
            <canvas id="waveform-x-axis" width="1200" height="40"></canvas>
            <canvas id="waveform-buttons" width="1200" height="121"></canvas>

            <!-- Navigation Bar gear icon + popover -->
            <div class="panel-gear" id="navBarGear">
                <span class="gear-btn" role="button" aria-label="Navigation bar settings">&#9881;</span>
                <div class="gear-popover" id="navBarPopover">
                    <div class="gear-popover-title">Navigation Bar</div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Mode:</span>
                        <select id="viewingMode" class="gear-select">
                            <option value="full" selected>Region Creation</option>
                            <option value="pageTurn">Windowed Page Turn</option>
                            <option value="scroll">Windowed Scroll</option>
                            <option value="static">Windowed Static</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Click:</span>
                        <select id="navBarClick" class="gear-select">
                            <option value="moveWindow" selected>Move window</option>
                            <option value="moveAndPlay">Move & play</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Show:</span>
                        <select id="miniMapView" class="gear-select">
                            <option value="linePlot" selected>Line Plot</option>
                            <option value="spectrogram">Spectrogram</option>
                            <option value="both">Combination</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Scroll:</span>
                        <select id="navBarScroll" class="gear-select">
                            <option value="zoom" selected>Zoom</option>
                            <option value="none">No action</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Markers:</span>
                        <select id="navBarMarkers" class="gear-select">
                            <option value="daily" selected>Daily</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                </div>
            </div>

            <canvas id="spectrogram" width="1200" height="554"></canvas>
            <canvas id="spectrogram-axis" width="60" height="554"></canvas>
            <canvas id="spectrogram-x-axis" width="1200" height="40"></canvas>

            <!-- Main Window gear icon + popover -->
            <div class="panel-gear" id="mainWindowGear">
                <span class="gear-btn" role="button" aria-label="Main window settings">&#9881;</span>
                <div class="gear-popover" id="mainWindowPopover">
                    <div class="gear-popover-title">Main Window</div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Show:</span>
                        <select id="mainWindowView" class="gear-select">
                            <option value="spectrogram" selected>Spectrogram</option>
                            <option value="timeSeries">Time Series</option>
                            <option value="both">Combination</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Click:</span>
                        <select id="mainWindowClick" class="gear-select">
                            <option value="noAction" selected>No action</option>
                            <option value="playAudio">Play audio</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Release:</span>
                        <select id="mainWindowRelease" class="gear-select">
                            <option value="playAudio" selected>Play audio</option>
                            <option value="noAction">No action</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Drag:</span>
                        <select id="mainWindowDrag" class="gear-select">
                            <option value="drawFeature" selected>Draw feature</option>
                            <option value="noAction">No action</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Scroll:</span>
                        <select id="mainWindowScroll" class="gear-select">
                            <option value="zoom" selected>Zoom</option>
                            <option value="none">No action</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Markers:</span>
                        <select id="mainWindowMarkers" class="gear-select">
                            <option value="daily" selected>Daily</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">X-Axis:</span>
                        <select id="mainWindowXAxis" class="gear-select">
                            <option value="show" selected>Show Ticks</option>
                            <option value="hide">Hide Ticks</option>
                        </select>
                    </div>
                    <div class="gear-popover-title">Feature Numbers</div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Color:</span>
                        <select id="mainWindowNumbers" class="gear-select">
                            <option value="hide">Hide</option>
                            <option value="white">White</option>
                            <option value="red" selected>Red</option>
                        </select>
                    </div>
                    <div class="gear-popover-row">
                        <span class="gear-label">Location:</span>
                        <select id="mainWindowNumbersLoc" class="gear-select">
                            <option value="above" selected>Above box</option>
                            <option value="inside">Inside box</option>
                        </select>
                    </div>
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 30px; margin-top: 8px; padding-top: 4px; padding-bottom: 0; padding-left: 8px; padding-right: 40px;">
                <div id="oscilloscope-panel" style="display: block; pointer-events: none;">
                    <div style="position: relative; border-radius: 5px; padding: 4px; background: linear-gradient(135deg, rgba(40, 40, 70, 0.85) 0%, rgba(25, 25, 55, 0.8) 100%); box-shadow: 0 0 5px rgba(102, 126, 234, 0.2), inset 0 0 20px rgba(80, 90, 130, 0.5);">
                        <canvas id="oscilloscope" width="106" height="28" style="display: block; width: 106px; height: 28px; border-radius: 2px; background: rgba(3, 3, 8, 0.98);"></canvas>
                        <div id="oscilloscope-frost" style="position: absolute; top: 0; left: 0; width: 106px; height: 28px; border-radius: 2px; pointer-events: none; opacity: 0.5;"></div>
                    </div>
                </div>
                <label id="advancedToggle" style="display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; font-size: 14px; font-weight: 700; color: #ffe8d0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); white-space: nowrap;">
                    Advanced
                    <input type="checkbox" id="advancedMode" style="width: 16px; height: 16px; cursor: pointer; accent-color: #80d0ff;">
                </label>
                <div class="viz-controls" style="display: flex; align-items: center; gap: 30px; margin-left: auto;">
                    <div style="display: none;">
                        <input type="checkbox" id="playOnClick" checked>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <label for="liveAnnotation" style="margin-bottom: 0; cursor: pointer; font-weight: 700; font-size: 14px; color: #ffe8d0; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); white-space: nowrap; user-select: none;">Live Annotation</label>
                        <input type="checkbox" id="liveAnnotation" checked style="width: 16px; height: 16px; cursor: pointer; accent-color: #80d0ff;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="fftSize" style="font-size: 14px; font-weight: 700; white-space: nowrap; user-select: none; color: #e8e8ff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">FFT:</label>
                        <select id="fftSize" style="padding: 4px 8px; font-size: 14px; font-weight: 600; border-radius: 4px; border: 1px solid #ccc; background: rgba(255, 255, 255, 0.95); cursor: pointer;">
                            <option value="512">512</option>
                            <option value="1024">1024</option>
                            <option value="2048" selected>2048</option>
                            <option value="4096">4096</option>
                            <option value="8192">8192</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="colormap" style="font-size: 14px; font-weight: 700; white-space: nowrap; user-select: none; color: #e8e8ff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Color Map:</label>
                        <select id="colormap" style="padding: 4px 8px; font-size: 14px; font-weight: 600; border-radius: 4px; border: 1px solid #ccc; background: rgba(255, 255, 255, 0.95); cursor: pointer;">
                            <option value="inferno" selected>Inferno</option>
                            <option value="solar">Solar</option>
                            <option value="aurora">Aurora</option>
                            <option value="jet">Jet</option>
                            <option value="plasma">Plasma</option>
                            <option value="turbo">Turbo</option>
                            <option value="viridis">Viridis</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label for="frequencyScale" style="font-size: 14px; font-weight: 700; white-space: nowrap; user-select: none; color: #e8e8ff; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Frequency Scale:</label>
                        <select id="frequencyScale" style="padding: 4px 8px; font-size: 14px; font-weight: 600; border-radius: 4px; border: 1px solid #ccc; background: rgba(255, 255, 255, 0.95); cursor: pointer;">
                            <option value="logarithmic" selected>Logarithmic</option>
                            <option value="sqrt">Square Root</option>
                            <option value="linear">Linear</option>
                        </select>
                    </div>
                    <div style="display: none;">
                        <input type="number" id="minFreqMultiplier" value="3.8" step="0.1" min="0.1" max="20">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hamburger menu button (top-left, Advanced mode only) -->
        <div id="hamburgerBtn" class="hamburger-btn" title="Settings drawer">&#9776;</div>

        <!-- Settings drawer (slides in from left, pushes content) -->
        <div id="settingsDrawer" class="settings-drawer">
            <div class="drawer-header">
                <span class="drawer-title">Settings</span>
                <span id="drawerClose" class="drawer-close" title="Close">&times;</span>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Session</div>
                <div class="drawer-row">
                    <label for="skipLoginWelcome" class="drawer-label">Skip Login & Welcome</label>
                    <input type="checkbox" id="skipLoginWelcome" class="drawer-checkbox">
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Panel Heights (px)</div>
                <div class="drawer-row">
                    <label for="heightMinimap" class="drawer-label">Minimap</label>
                    <input type="number" id="heightMinimap" class="drawer-input" min="50" max="400" step="1">
                </div>
                <div class="drawer-row">
                    <label for="heightSpectrogram" class="drawer-label">Spectrogram</label>
                    <input type="number" id="heightSpectrogram" class="drawer-input" min="200" max="1200" step="1">
                </div>
            </div>
            <div class="drawer-section">
                <div class="drawer-section-title">Tile Compression</div>
                <div class="drawer-row">
                    <label for="tileCompression" class="drawer-label">Format</label>
                    <select id="tileCompression" class="drawer-input" style="width: 100px; text-align: left;">
                        <option value="uint8">Uint8</option>
                        <option value="bc4">BC4</option>
                    </select>
                </div>
                <div class="drawer-row">
                    <span id="tileCompressionInfo" style="font-size: 11px; color: #888;"></span>
                </div>
            </div>
            <!-- Additional settings sections will be added here -->
        </div>

        <!-- Tracked Regions Panel -->
        <div class="panel panel-regions" id="trackedRegionsPanel" style="position: relative; display: none;">
            <h2 style="margin-bottom: 12px; font-size: 1.3em;">Selected Regions</h2>
            <div id="regionsListContainer">
                <div id="regionsList"></div>
            </div>
            <div id="downloadAudioContainer" style="position: absolute; bottom: -50px; right: 0; display: none; z-index: 100; gap: 8px;">
                <button type="button" id="recordAudioBtn" style="padding: 9px 18px; background: linear-gradient(135deg, #b85050 0%, #963030 100%); color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; height: 38px;">üî¥ Begin Recording</button>
                <button type="button" id="downloadAllComponentsBtn" style="display: none; padding: 9px 18px; background: linear-gradient(135deg, #aa6655 0%, #884433 100%); color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; height: 38px;">üì¶ Download All Components</button>
                <button type="button" id="downloadAudioBtn" style="padding: 9px 18px; background: linear-gradient(135deg, #aa6655 0%, #884433 100%); color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; height: 38px;">üì• Download This Component</button>
            </div>
        </div>
        
        <!-- Questionnaires Panel -->
        <div class="panel" id="questionnairesPanel" style="padding: 10px 15px; background: var(--accent-bg); border: 2px solid rgba(255, 255, 255, 0.12); display: none;">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <label style="font-size: var(--panel-label-size); font-weight: 600; color: #888; white-space: nowrap;">Questionnaires:</label>
                <button type="button" id="backgroundQuestionBtn" class="emic-btn" style="padding: 6px 14px; font-size: 14px;">üìã Background</button>
                <button type="button" id="dataAnalysisQuestionBtn" class="emic-btn" style="padding: 6px 14px; font-size: 14px;">üìã Data Analysis Experience</button>
                <button type="button" id="feedbackQuestionBtn" class="emic-btn" style="padding: 6px 14px; font-size: 14px;">üìã Feedback</button>
                <button type="button" id="referralQuestionBtn" class="emic-btn" style="padding: 6px 14px; font-size: 14px;">üìã How Did You Learn?</button>
            </div>
        </div>

        <!-- Metrics Panel (hidden by default) -->
        <div class="panel panel-metrics" id="metricsPanel" style="display: none;">
            <div class="metrics">
                <div class="metric"><div class="metric-label">Time to First Audio</div><div class="metric-value" id="ttfa">--</div></div>
                <div class="metric"><div class="metric-label">Download Size</div><div class="metric-value" id="downloadSize">--</div></div>
                <div class="metric"><div class="metric-label">Sample Count</div><div class="metric-value" id="sampleCount">--</div></div>
                <div class="metric"><div class="metric-label">Current Position</div><div class="metric-value" id="currentPosition">0m 0s</div></div>
                <div class="metric"><div class="metric-label">Playback Duration</div><div class="metric-value" id="playbackDuration">--</div></div>
            </div>
        </div>
        
        <!-- Simulate Row (hidden for EMIC study) -->
        <div class="panel panel-simulate" style="padding: 15px 20px; display: none;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <button type="button" id="participantModalBtn" style="display:none;">üë§ Participant Setup</button>
                <button type="button" id="welcomeModalBtn" style="display:none;">üëã Welcome</button>
                <button type="button" id="preSurveyModalBtn" style="display:none;">üìä Pre-Survey</button>
                <button type="button" id="activityLevelModalBtn" style="display:none;">üåã Activity Level</button>
                <button type="button" id="awesfModalBtn" style="display:none;">‚ú® AWE-SF</button>
                <button type="button" id="postSurveyModalBtn" style="display:none;">üìä Post-Survey</button>
                <button type="button" id="endModalBtn" style="display:none;">üéâ End</button>
                <button type="button" id="submitBtn" style="display:none;">üì§ Submit to Qualtrics</button>
                <button type="button" id="adminModeBtn" style="display:none;">üëë Admin Mode: OFF</button>
            </div>
        </div>
    </div>

    <!-- Permanent Modal Overlay -->
    <script>
        // Hide overlay immediately if skip login is set ‚Äî prevents flash
        if (localStorage.getItem('emic_skip_login_welcome') === 'true') {
            document.write('<div id="permanentOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.65); z-index: 1000; align-items: center; justify-content: center; opacity: 0;"></div>');
        } else {
            document.write('<div id="permanentOverlay" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.65); z-index: 1000; align-items: center; justify-content: center; opacity: 1;"></div>');
        }
    </script>
    
    <!-- Hidden participant ID/name elements that existing JS may reference -->
    <div id="participantIdDisplay" style="display: none;">
        <span id="participantIdText"><span id="participantIdValue"></span></span>
    </div>
    <div id="tutorialHelpBtn" style="display: none;"></div>
    
    <!-- CORE SYSTEM -->
    <script type="module">
        console.groupCollapsed('üî• [CORE] Core Systems Initialization');
        import { initFlameEngine } from './js/core/flame-engine.js';
        import { initErrorSystem } from './js/core/error-system.js';
        const flame = initFlameEngine();
        const errorSystem = initErrorSystem(flame);
        window.enterOverheatMode = () => flame.enterOverheatMode();
        window.exitOverheatMode = () => flame.exitOverheatMode();
        console.log('üî• Core systems initialized (flame engine + error system)');
        console.groupEnd();
    </script>
    
    <!-- EMIC Study: IndexedDB caching layer for hardcoded GOES-16 data -->
    <script>
        // EMIC-specific IndexedDB cache (emic-study-cache / audio-data)
        // Wraps the normal fetch pipeline with a persistent local cache
        window.__emicCache = {
            DB_NAME: 'emic-study-cache',
            STORE_NAME: 'audio-data',
            _getKey: function() {
                var c = window.__EMIC_CONFIG;
                return c.dataset + '_' + c.startTime + '_' + c.endTime + '_b_gse';
            },
            openDB: function() {
                var self = this;
                return new Promise(function(resolve, reject) {
                    var req = indexedDB.open(self.DB_NAME, 1);
                    req.onupgradeneeded = function(e) {
                        e.target.result.createObjectStore(self.STORE_NAME);
                    };
                    req.onsuccess = function(e) { resolve(e.target.result); };
                    req.onerror = function(e) { reject(e.target.error); };
                });
            },
            get: async function() {
                try {
                    var db = await this.openDB();
                    return new Promise(function(resolve, reject) {
                        var tx = db.transaction('audio-data', 'readonly');
                        var req = tx.objectStore('audio-data').get(window.__emicCache._getKey());
                        req.onsuccess = function() { resolve(req.result || null); };
                        req.onerror = function() { resolve(null); };
                    });
                } catch(e) { return null; }
            },
            put: async function(blob) {
                try {
                    var db = await this.openDB();
                    return new Promise(function(resolve, reject) {
                        var tx = db.transaction('audio-data', 'readwrite');
                        tx.objectStore('audio-data').put(blob, window.__emicCache._getKey());
                        tx.oncomplete = function() { resolve(); };
                        tx.onerror = function() { resolve(); };
                    });
                } catch(e) { /* ignore */ }
            }
        };
    </script>

    <!-- APPLICATION LAYER -->
    <script type="module" src="js/main.js?v=20260212g"></script>
    
    <!-- EMIC Study: Hook fetch button for IndexedDB caching + status updates -->
    <script type="module">
        if (window.__EMIC_STUDY_MODE) {
            // Wait for DOM + main.js to initialize
            const startBtn = document.getElementById('startBtn');
            const statusEl = document.getElementById('status');
            if (startBtn) {
                // Add our handler BEFORE main.js's handler (capture phase)
                startBtn.addEventListener('click', async function(e) {
                    if (!statusEl) return;
                    // Check EMIC IndexedDB cache first
                    const cached = await window.__emicCache.get();
                    if (cached) {
                        statusEl.textContent = 'üì¶ Loading from cache...';
                        statusEl.className = 'status info';
                        console.log('üî¨ EMIC: Found data in IndexedDB cache');
                    } else {
                        statusEl.textContent = 'üì° Fetching GOES-16 magnetometer data from CDAWeb...';
                        statusEl.className = 'status loading';
                        console.log('üî¨ EMIC: No cache, will fetch from CDAWeb');
                    }
                }, true); // capture phase = runs first

                // After fetch completes, store in EMIC cache
                // Listen for the worklet data-complete which signals successful load
                const origAddEventListener = startBtn.addEventListener;
                window.addEventListener('componentsReady', async function() {
                    // Data loaded successfully - cache it
                    try {
                        const { getAudioData } = await import('./js/cdaweb-cache.js');
                        const c = window.__EMIC_CONFIG;
                        const spacecraft = c.dataset.includes('G16') ? 'GOES-16' : 'GOES-19';
                        const entry = await getAudioData(spacecraft, c.dataset, c.startTime, c.endTime);
                        if (entry && entry.wavBlob) {
                            await window.__emicCache.put(entry.wavBlob);
                            console.log('üî¨ EMIC: Cached WAV in IndexedDB');
                        }
                    } catch(e) { console.warn('EMIC cache store failed:', e); }
                });
            }
        }
    </script>
    
    <!-- EMIC Study: Read participant ID from URL param -->
    <script>
        (function() {
            var params = new URLSearchParams(window.location.search);
            var pid = params.get('pid') || params.get('participant') || '';
            var input = document.getElementById('emicParticipantId');
            if (pid && input) {
                input.value = pid;
                input.title = 'Participant ID set via URL';
            } else if (input) {
                input.removeAttribute('readonly');
                input.placeholder = 'Enter your ID...';
            }
            
            // Wire up stretch/speed button toggles
            document.querySelectorAll('.emic-btn[data-stretch]').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    document.querySelectorAll('.emic-btn[data-stretch]').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');

                    // Map button data-stretch values to algorithm names used by audio-player
                    var stretchMap = { resample: 'resample', granular: 'granular', paulstretch: 'paul', wavelet: 'wavelet' };
                    var algorithm = stretchMap[btn.getAttribute('data-stretch')] || 'paul';
                    var { switchStretchAlgorithm } = await import('./js/audio-player.js');
                    switchStretchAlgorithm(algorithm);
                });
            });
            document.querySelectorAll('.emic-btn[data-speed]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.emic-btn[data-speed]').forEach(function(b) { b.classList.remove('active'); });
                    btn.classList.add('active');

                    var speed = parseFloat(btn.getAttribute('data-speed'));
                    var slider = document.getElementById('playbackSpeed');
                    if (!slider) return;

                    // Reverse the logarithmic mapping: speed -> slider value
                    var sliderValue;
                    if (speed <= 1.0) {
                        sliderValue = 667 * Math.log10(speed / 0.1);
                    } else {
                        sliderValue = 667 + 333 * Math.log(speed) / Math.log(15);
                    }
                    slider.value = Math.round(sliderValue);
                    slider.dispatchEvent(new Event('input'));
                });
            });
        })();
    </script>

    <!-- Tile compression dropdown wiring -->
    <script type="module">
        const tileCompressionSelect = document.getElementById('tileCompression');
        if (tileCompressionSelect) {
            window.addEventListener('spectrogram-ready', async () => {
                const { isTileBC4Supported, getTileCompression, setTileCompression } = await import('./js/spectrogram-three-renderer.js');
                const infoEl = document.getElementById('tileCompressionInfo');
                
                if (!isTileBC4Supported()) {
                    const bc4Option = tileCompressionSelect.querySelector('option[value="bc4"]');
                    if (bc4Option) {
                        bc4Option.disabled = true;
                        bc4Option.textContent = 'BC4 (not supported)';
                    }
                    if (infoEl) infoEl.textContent = 'BC4 requires EXT_texture_compression_rgtc';
                } else {
                    if (infoEl) infoEl.textContent = 'BC4: 0.5 bytes/texel ‚Äî Uint8: 1 byte/texel';
                }
                
                tileCompressionSelect.value = getTileCompression();
                
                tileCompressionSelect.addEventListener('change', () => {
                    setTileCompression(tileCompressionSelect.value);
                    localStorage.setItem('tileCompression', tileCompressionSelect.value);
                });
                
                const saved = localStorage.getItem('tileCompression');
                if (saved && (saved === 'uint8' || saved === 'bc4')) {
                    tileCompressionSelect.value = saved;
                    setTileCompression(saved);
                }
            });
        }
    </script>
</body>
</html>
